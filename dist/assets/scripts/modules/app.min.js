"use strict";define(["require","helper.min","loader.min","jquery","libs/jquery.idle/jquery.idle.min"],function(t,e,a,n){!function(t,r){var s={cache:{elements:[],images:[],snippets:[]},state:{total:0,rendered:[],items:[],animations:[],width:0,animating:!1},resourcesPath:"",interfacesPath:"",init:function(){var i=this;i.resourcesPath=t.location.href+"dist/assets",i.interfacesPath=t.location.href+"interfaces",i.cache.elements.push(n(".row").not("#middle")),i.cache.elements.push(n(".row").filter("#middle")),e.attachEventsFramework(a),e.attachEventsFramework(i),i.listenToOnce(a,"xmlReady",n.proxy(i.renderItems,i)),i.listenToOnce(i,"renderReady",n.proxy(i.attachEvents,i)),i.listenTo(i,"expandItem",n.proxy(i.expandItem,i)),i.listenTo(i,"contractItem",n.proxy(i.contractItem,i)),i.listenTo(i,"showInfo",n.proxy(i.showInfo,i)),i.listenTo(i,"hideInfo",n.proxy(i.hideInfo,i)),i.listenTo(i,"scrollTo",n.proxy(i.scrollTo,i)),a.fetch([i.resourcesPath+"/xml/xml1.xml",i.resourcesPath+"/xml/xml2.xml"],{})},renderItems:function(t){var i=this;if(t.length>0){var a=[];i.state.total=e.getLength(t,1),i.state.width=i.state.total/t.length/100,n.each(t,function(r,s){var r=parseInt(r),o=n(i.cache.elements[0][r]);o.on("DOMNodeInserted",".item",n.proxy(i.itemRendered,i));for(c in s){var c=parseInt(c),m=n.Deferred(),d={row:r,id:c,deferred:m};i.state.rendered.push(d),a.push(m);var h=t[r][c],f=n("<div></div>",{"class":"item",id:r+"-item-"+c}),l=i.buildImagePaths(h.media),u={row:r,id:c,paths:l};i.cache.images.push(u);var v={row:r,id:c,content:h.snippet};i.cache.snippets.push(v),f.css({background:"transparent url("+l[1]+") 0 0 no-repeat","background-size":"contain",width:i.state.width+"%"});var g=n("<img />",{"class":"img",src:l[1]}),p=n("<div></div>",{"class":"info"}),I=n('<a class="icon" href="#"><img src="'+i.resourcesPath+'/images/info.png" /></a>'),w=e.concatText(h.building,h.location,"Architect: "+h.architect,h.date,"Photo: "+h.credit),y=n("<div></div>",{"class":"text"}).html(w);p.append(I,y),o.append(f.append(g,p))}}),n.when.apply(i,a).done(n.proxy(function(){this.clearState("rendered",[]),this.trigger("renderReady")},i))}},validate:function(t,e,i){var a=this;switch(i){case"enter":if(e.hasClass("active"))return!1;var r=a.getItems(!1,".active");r.length>0&&n.each(r,function(e,i){var i=n(i);a.getItemId(i)!=t&&i.trigger("mouseleave")});break;case"leave":if(!e.hasClass("active"))return!1}return!0},attachEvents:function(){var i=this;n.each(i.cache.elements[0],function(a,r){var s=n(r).find(".item");s.length>0&&(s.on({"mouseenter click":function(a){var r=n(this),s=i.getItemRowId(r),o=i.getItemId(r),c=s+":"+o,m=r.find(".img");if(i.validate(o,r,"enter")){r.attr("class","item active"),r.stop(!0);try{var d=i.getItems(o,".active",!0)[0];d&&n(d).trigger("mouseenter");var h=e.find(i.cache.images,{row:s,id:o})[0];if(h){var f=h.paths[0];m.attr("src",f),i.state.animations[c]={timestamp:0};var l=t.requestAnimationFrame(n.proxy(i.detectImage,i,o,s,r,m));l&&(i.state.animations[c].id=l)}}catch(u){}}},mouseleave:function(e){var a=n(this),r=i.getItemRowId(a),s=i.getItemId(a),o=r+":"+s,c=a.find(".img");if(i.validate(s,a,"leave")){a.attr("class","item"),a.stop(!0),a.find(".info").trigger("info:hide");try{var m=i.getItems(s,".active",!1)[0];m&&n(m).trigger("mouseleave"),i.state.animations[o]&&(t.cancelAnimationFrame(i.state.animations[o].id),i.state.animations[o]={id:0,timestamp:0},i.trigger("contractItem",s,r,a,c))}catch(d){}}}}),s.find(".icon").on({mouseenter:function(t){var e=n(this),a=e.parents(".item"),r=i.getItemId(a),s=i.getItems(r,"",!1);s.length>0&&n.each(s,function(t,e){var e=n(e);e.find(".info").find(".text").show().end().attr("class","info active")})},click:function(t){t.preventDefault()}}),s.find(".info").on({mouseleave:function(t){var e=n(this),a=e.parents(".item"),r=i.getItemId(a),s=i.getItems(r,"",!1);s.length>0&&n.each(s,function(t,e){var e=n(e);e.find(".info").find(".text").hide().end().attr("class","info")})},"info:hide":function(t){var e=n(this),a=e.parents(".item"),r=i.getItemId(a),s=i.getItems(r,"",!1);s.length>0&&n.each(s,function(t,e){var e=n(e);e.find(".info").find(".text").hide().end().attr("class","info")})}}))});var a=!1,r=0,s=0;n(document).on("mousemove",function(t){var e=t.pageX-window.pageXOffset,i=t.pageY;console.log(r,s,e,i),e!=r||i!=s?(r=e,s=i,a=!1):a=!0});var o=0,c=n(i.cache.elements[1]);n(document).idle({onIdle:function(){i.state.animating=!0;var e=0,a=function(r){try{0==e&&(e=r);var s=r-e;if(1e4>s)o=t.requestAnimationFrame(a);else{var c=i.getItems(!1,".active")[0];c&&n(c).trigger("mouseleave");var m=i.state.total/i.cache.elements[0].length,d=0,h=Math.floor(Math.random()*(m-d))+d,f=i.getItems(h)[0];f.trigger("mouseenter"),t.cancelAnimationFrame(o),e=0,o=t.requestAnimationFrame(a)}}catch(l){}};o=t.requestAnimationFrame(a),c.find("h1").attr("class","inactive").end().find("h2").attr("class","")},onActive:function(){if(console.log(a),!a){try{var e=i.getItems(!1,".active")[0];e&&n(e).trigger("mouseleave")}catch(r){}i.state.animating=!1,t.cancelAnimationFrame(o),c.find("h1").attr("class","").end().find("h2").attr("class","inactive")}},idle:6e4,events:"mousemove touchstart"})},detectImage:function(e,i,a,r,s){var o=this,c=i+":"+e;0==o.state.animations[c].timestamp&&(o.state.animations[c].timestamp=s);var m=s-o.state.animations[c].timestamp,d=r.prop("complete");if(2e3>m&&!d){var h=t.requestAnimationFrame(n.proxy(o.detectImage,o,e,i,a,r));h&&(o.state.animations[c].id=h)}else d&&o.trigger("expandItem",e,i,a,r)},expandItem:function(e,i,a,r){var s=this;try{var o=r.width(),c=n(t).width(),m=o/c*100;a.animate({width:m+"%"},{duration:2e3,complete:function(){var t=s.state.items.indexOf(e);0>t?s.state.items.push(e):s.state.animating&&s.trigger("scrollTo",e),s.trigger("showInfo",a)}})}catch(d){}},contractItem:function(t,i,a,n){var r=this;try{a.animate({width:r.state.width+"%"},{duration:2e3,complete:function(){var s=r.state.items.indexOf(t);s>-1&&r.state.items.splice(s,1);var o=e.find(r.cache.images,{row:i,id:t})[0];if(o){var c=o.paths[1];n.attr("src",c)}r.trigger("hideInfo",a)}})}catch(s){}},scrollTo:function(e){var i=this,a=n(t).width(),s=(n(r).outerWidth(),n(t).prop("pageXOffset")),o=i.getItems(e,".active"),c=0,m=0;if(o.length>0){n.each(o,function(t,e){var e=n(e),i=e.find(".img").width();m=e.position().left,i>c&&(c=i)});var d=m+c>s+a?!0:!1;if(d){var h=m+c-(s+a);n("html, body").animate({scrollLeft:"+="+h+"px"},{duration:1e3})}else{var f=s>m?!0:!1;if(f){var l=s-m;n("html, body").animate({scrollLeft:"-="+l+"px"},{duration:1e3})}}}},showInfo:function(t){var e=t.find(".icon");e.show()},hideInfo:function(t){var e=t.find(".icon");e.hide()},getItems:function(t,e,i){var a=this,r=[];return n.each(a.cache.elements[0],function(a,s){var o;i?(o=t||"number"==typeof t?n(s).find('.item[id$="-'+t+'"]'):n(s).find(".item"),e&&(o=o.not(e))):(o=t||"number"==typeof t?n(s).find('.item[id$="-'+t+'"]'):n(s).find(".item"),e&&(o=o.filter(e))),o.length>0&&r.push(o)}),r},itemRendered:function(t){var i=this,a=t.target,n=i.getItemRowId(a),r=i.getItemId(a);if("number"==typeof n&&"number"==typeof r){var s=e.find(i.state.rendered,{row:n,id:r});s.length>0&&s[0].deferred.resolve()}},getItemId:function(t){try{var e=n(t).attr("id"),i=/\d+$/,a=e.match(i);if(a.length>0)return parseInt(a[0])}catch(r){}return!1},getItemRowId:function(t){try{var e=n(t).attr("id"),i=/^\d+/,a=e.match(i);if(a.length>0)return parseInt(a[0])}catch(r){}return!1},clearState:function(t,e){var i=this;"undefined"!=typeof i.state[t]&&(i.state[t]=e)},buildImagePaths:function(t){var e=[this.interfacesPath+"/img.php?src=/"+t+"&h=600",this.interfacesPath+"/img.php?src=/"+t+"&h=600&crop-to-fit&a=0,75,0,0"];for(i=0;i<e.length;i++){n("<img />",{src:e[i]})}return e}};s.init()}(window,document)});